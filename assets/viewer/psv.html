<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>360¬∞ Panorama Viewer</title>

        <!-- Photo Sphere Viewer CSS -->
        <link rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5.7.4/index.min.css">

        <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #viewer {
            width: 100vw;
            height: 100vh;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 1000;
        }
        
        #loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            text-align: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        
        .control-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #gyro-permission {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 193, 7, 0.9);
            color: #000;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            text-align: center;
            cursor: pointer;
            display: none;
        }
    </style>
    </head>
    <body>
        <div id="loading">
            <div class="spinner"></div>
            <div>Cargando panorama...</div>
        </div>

        <div id="error" style="display: none;">
            <h3>Error al cargar la imagen</h3>
            <p id="error-message"></p>
        </div>

        <div id="gyro-permission">
            Toca aqu√≠ para habilitar el giroscopio
        </div>

        <div id="viewer"></div>

        <div id="controls">
            <button class="control-btn" id="center-btn">üìç Centrar</button>
            <button class="control-btn" id="gyro-btn">üß≠ Giroscopio:
                OFF</button>
            <button class="control-btn" id="zoom-in-btn">üîç +</button>
            <button class="control-btn" id="zoom-out-btn">üîç -</button>
        </div>

        <!-- Photo Sphere Viewer JS -->
        <script
            src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5.7.4/index.min.js"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/gyroscope-plugin@5.7.4/index.min.js"></script>

        <script>
        class PanoramaViewer {
            constructor() {
                this.viewer = null;
                this.gyroscopePlugin = null;
                this.isGyroEnabled = false;
                this.isGyroAvailable = false;
                this.initialYaw = 0;
                this.initialPitch = 0;
                
                this.initializeElements();
                this.setupMessageListener();
                this.checkGyroscopeAvailability();
            }
            
            initializeElements() {
                this.loadingEl = document.getElementById('loading');
                this.errorEl = document.getElementById('error');
                this.errorMessageEl = document.getElementById('error-message');
                this.gyroPermissionEl = document.getElementById('gyro-permission');
                this.centerBtn = document.getElementById('center-btn');
                this.gyroBtn = document.getElementById('gyro-btn');
                this.zoomInBtn = document.getElementById('zoom-in-btn');
                this.zoomOutBtn = document.getElementById('zoom-out-btn');
                
                // Setup control buttons
                this.centerBtn.addEventListener('click', () => this.centerView());
                this.gyroBtn.addEventListener('click', () => this.toggleGyroscope());
                this.zoomInBtn.addEventListener('click', () => this.zoomIn());
                this.zoomOutBtn.addEventListener('click', () => this.zoomOut());
                this.gyroPermissionEl.addEventListener('click', () => this.requestGyroPermission());
            }
            
            setupMessageListener() {
                // Listen for messages from React Native WebView
                window.addEventListener('message', (event) => {
                    try {
                        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                        this.handleMessage(data);
                    } catch (error) {
                        console.error('Error parsing message:', error);
                    }
                });
                
                // Also listen for document messages (alternative method)
                document.addEventListener('message', (event) => {
                    try {
                        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                        this.handleMessage(data);
                    } catch (error) {
                        console.error('Error parsing document message:', error);
                    }
                });
            }
            
            handleMessage(data) {
                console.log('Received message:', data);
                
                switch (data.type) {
                    case 'INIT':
                        this.initViewer(data);
                        break;
                    case 'UPDATE_GYRO':
                        this.setGyroscopeEnabled(data.enabled);
                        break;
                    case 'UPDATE_IMAGE':
                        this.updateImage(data.imageUrl || data.imageBase64);
                        break;
                    case 'CENTER_VIEW':
                        this.centerView();
                        break;
                }
            }
            
            async checkGyroscopeAvailability() {
                try {
                    // Check if DeviceOrientationEvent is available
                    if (typeof DeviceOrientationEvent !== 'undefined') {
                        // For iOS 13+ we need to request permission
                        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                            this.isGyroAvailable = true;
                            // Don't request permission automatically, wait for user interaction
                        } else {
                            // Android or older iOS
                            this.isGyroAvailable = true;
                        }
                    }
                } catch (error) {
                    console.log('Gyroscope not available:', error);
                    this.isGyroAvailable = false;
                }
                
                this.updateGyroButton();
            }
            
            async requestGyroPermission() {
                try {
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission === 'granted') {
                            this.gyroPermissionEl.style.display = 'none';
                            this.isGyroAvailable = true;
                            this.updateGyroButton();
                            return true;
                        } else {
                            this.showError('Permisos de giroscopio denegados');
                            return false;
                        }
                    }
                    return true;
                } catch (error) {
                    console.error('Error requesting gyro permission:', error);
                    this.showError('Error al solicitar permisos de giroscopio');
                    return false;
                }
            }
            
            async initViewer(data) {
                try {
                    this.hideError();
                    this.showLoading();
                    
                    const { imageUrl, imageBase64, useGyro, initialYaw = 0, initialPitch = 0 } = data;
                    this.initialYaw = initialYaw;
                    this.initialPitch = initialPitch;
                    
                    // Determine image source
                    let panorama;
                    if (imageUrl) {
                        panorama = imageUrl;
                    } else if (imageBase64) {
                        panorama = `data:image/png;base64,${imageBase64}`;
                    } else {
                        throw new Error('No image provided');
                    }
                    
                    // Create viewer configuration
                    const config = {
                        container: 'viewer',
                        panorama: panorama,
                        loadingImg: null,
                        navbar: false,
                        defaultYaw: this.initialYaw * Math.PI / 180, // Convert to radians
                        defaultPitch: this.initialPitch * Math.PI / 180,
                        minFov: 30,
                        maxFov: 90,
                        mousewheel: true,
                        mousemove: true,
                        touchmoveTwoFingers: true,
                        plugins: []
                    };
                    
                    // Add gyroscope plugin if available and requested
                    if (this.isGyroAvailable && useGyro) {
                        config.plugins.push([PhotoSphereViewer.GyroscopePlugin, {
                            touchmove: true,
                            absolutePosition: true
                        }]);
                    }
                    
                    // Destroy existing viewer
                    if (this.viewer) {
                        this.viewer.destroy();
                    }
                    
                    // Create new viewer
                    this.viewer = new PhotoSphereViewer.Viewer(config);
                    
                    // Get gyroscope plugin reference
                    this.gyroscopePlugin = this.viewer.getPlugin(PhotoSphereViewer.GyroscopePlugin);
                    this.isGyroEnabled = this.gyroscopePlugin && useGyro;
                    
                    // Setup event listeners
                    this.viewer.addEventListener('ready', () => {
                        this.hideLoading();
                        console.log('Viewer ready');
                    });
                    
                    this.viewer.addEventListener('panorama-loaded', () => {
                        this.hideLoading();
                        console.log('Panorama loaded');
                    });
                    
                    this.viewer.addEventListener('error', (event) => {
                        this.hideLoading();
                        this.showError(`Error cargando panorama: ${event.error?.message || 'Error desconocido'}`);
                    });
                    
                    this.updateGyroButton();
                    
                } catch (error) {
                    this.hideLoading();
                    this.showError(`Error inicializando viewer: ${error.message}`);
                    console.error('Viewer initialization error:', error);
                }
            }
            
            updateImage(imageSource) {
                if (this.viewer && imageSource) {
                    this.showLoading();
                    this.viewer.setPanorama(imageSource)
                        .then(() => {
                            this.hideLoading();
                        })
                        .catch((error) => {
                            this.hideLoading();
                            this.showError(`Error actualizando imagen: ${error.message}`);
                        });
                }
            }
            
            async toggleGyroscope() {
                if (!this.isGyroAvailable) {
                    this.showError('Giroscopio no disponible en este dispositivo');
                    return;
                }
                
                if (!this.gyroscopePlugin) {
                    this.showError('Plugin de giroscopio no inicializado');
                    return;
                }
                
                try {
                    // For iOS, request permission if needed
                    if (typeof DeviceOrientationEvent.requestPermission === 'function' && !this.isGyroEnabled) {
                        const hasPermission = await this.requestGyroPermission();
                        if (!hasPermission) {
                            return;
                        }
                    }
                    
                    if (this.isGyroEnabled) {
                        this.gyroscopePlugin.stop();
                        this.isGyroEnabled = false;
                    } else {
                        this.gyroscopePlugin.start();
                        this.isGyroEnabled = true;
                    }
                    
                    this.updateGyroButton();
                    
                } catch (error) {
                    console.error('Error toggling gyroscope:', error);
                    this.showError(`Error con giroscopio: ${error.message}`);
                }
            }
            
            setGyroscopeEnabled(enabled) {
                if (enabled && !this.isGyroEnabled) {
                    this.toggleGyroscope();
                } else if (!enabled && this.isGyroEnabled) {
                    this.toggleGyroscope();
                }
            }
            
            centerView() {
                if (this.viewer) {
                    this.viewer.animate({
                        yaw: this.initialYaw * Math.PI / 180,
                        pitch: this.initialPitch * Math.PI / 180,
                        zoom: 50
                    });
                }
            }
            
            zoomIn() {
                if (this.viewer) {
                    const currentZoom = this.viewer.getZoomLevel();
                    this.viewer.zoom(Math.min(currentZoom + 10, 100));
                }
            }
            
            zoomOut() {
                if (this.viewer) {
                    const currentZoom = this.viewer.getZoomLevel();
                    this.viewer.zoom(Math.max(currentZoom - 10, 0));
                }
            }
            
            updateGyroButton() {
                if (!this.isGyroAvailable) {
                    this.gyroBtn.textContent = 'üß≠ No disponible';
                    this.gyroBtn.disabled = true;
                } else {
                    this.gyroBtn.textContent = `üß≠ Giroscopio: ${this.isGyroEnabled ? 'ON' : 'OFF'}`;
                    this.gyroBtn.disabled = false;
                    
                    // Show permission prompt for iOS if needed
                    if (typeof DeviceOrientationEvent.requestPermission === 'function' && !this.isGyroEnabled) {
                        this.gyroPermissionEl.style.display = 'block';
                    }
                }
            }
            
            showLoading() {
                this.loadingEl.style.display = 'block';
            }
            
            hideLoading() {
                this.loadingEl.style.display = 'none';
            }
            
            showError(message) {
                this.errorMessageEl.textContent = message;
                this.errorEl.style.display = 'block';
                console.error('Viewer error:', message);
            }
            
            hideError() {
                this.errorEl.style.display = 'none';
            }
        }
        
        // Initialize viewer when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.panoramaViewer = new PanoramaViewer();
        });
        
        // Fallback initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                if (!window.panoramaViewer) {
                    window.panoramaViewer = new PanoramaViewer();
                }
            });
        } else {
            window.panoramaViewer = new PanoramaViewer();
        }
    </script>
    </body>
</html>
